name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  actions: write

jobs:
  validate-repo:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: ðŸ” Check for invalid git submodules
        run: |
          # Check for gitlinks (mode 160000) which indicate submodules
          if git ls-files --stage | grep -q '^160000'; then
            echo "âŒ Found gitlink entries (potential invalid submodules):"
            git ls-files --stage | grep '^160000'

            # Check if .gitmodules exists
            if [ ! -f .gitmodules ]; then
              echo "âŒ ERROR: Gitlink entries found but no .gitmodules file exists!"
              echo "This usually means a git repository was accidentally committed."
              exit 1
            fi

            # If .gitmodules exists, verify all submodules are properly configured
            git ls-files --stage | grep '^160000' | while read mode hash stage path; do
              if ! git config --file .gitmodules --get "submodule.$path.url" > /dev/null 2>&1; then
                echo "âŒ ERROR: Submodule '$path' has no URL configured in .gitmodules"
                exit 1
              fi
            done
          fi
          echo "âœ… No invalid submodule entries found"

      - name: ðŸš« Check that worktrees/ is not committed
        run: |
          if git ls-files | grep -q '^worktrees/'; then
            echo "âŒ ERROR: worktrees/ directory is committed to git!"
            echo "Git worktrees should never be committed."
            echo "Found files:"
            git ls-files | grep '^worktrees/'
            exit 1
          fi
          echo "âœ… No worktrees/ files committed"

  test:
    needs: validate-repo
    runs-on: macos-latest
    strategy:
      matrix:
        python-version: ["3.8", "3.9", "3.10", "3.11"]

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: ðŸ Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: âš¡ Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"

      - name: ðŸ› ï¸ Install just
        run: |
          brew install just

      - name: ðŸ“¦ Install dependencies
        run: |
          uv sync --extra dev

      - name: ðŸŽ¨ Check formatting
        run: |
          just fmt-check

      - name: âœ… Run type checking
        run: |
          just type-check

      - name: ðŸ” Run linting
        run: |
          just lint

      - name: ðŸ§ª Run tests with coverage
        run: |
          uv run pytest --cov=src/about_this_mac --cov-report=term-missing:skip-covered --cov-report=html tests/
          echo "Coverage report saved to htmlcov/index.html"

  dogfood:
    needs: test
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: ðŸ Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.11"
          cache: "pip"

      - name: âš¡ Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"

      - name: ðŸ› ï¸ Install just
        run: |
          brew install just

      - name: ðŸ“¦ Install package
        run: |
          uv sync

      - name: ðŸ“ Create output directory
        run: mkdir -p reports

      - name: ðŸ”„ Run tool in various formats
        run: |
          # Run in different formats and save outputs
          uv run about-this-mac --format text > reports/report.txt
          uv run about-this-mac --format json > reports/report.json
          uv run about-this-mac --format yaml > reports/report.yaml
          uv run about-this-mac --format markdown --output reports/report.md
          uv run about-this-mac --format public > reports/report_public.txt
          uv run about-this-mac --format simple > reports/report_simple.txt

          # Also save raw information for debugging
          uv run about-this-mac --hardware-info > reports/raw_hardware.txt
          uv run about-this-mac --power-info > reports/raw_power.txt
          uv run about-this-mac --graphics-info > reports/raw_graphics.txt
          uv run about-this-mac --storage-info > reports/raw_storage.txt
          uv run about-this-mac --memory-info > reports/raw_memory.txt
          uv run about-this-mac --audio-info > reports/raw_audio.txt
          uv run about-this-mac --network-info > reports/raw_network.txt

      - name: ðŸ“¤ Upload reports
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: mac-reports
          path: reports/
          retention-days: 14
